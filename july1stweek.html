<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>роХрогро┐род роКроЯро╛роЯрпБроорпН роЪро┐роорпБро▓рпЗро╖ройрпН</title>
    <script src=""./js/tailwind.js""></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+Tamil:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the simulation */
        body {
            font-family: 'Inter', 'Noto Sans Tamil', sans-serif;
            background-color: #f1f5f9; /* Slate 100 */
        }
        .tab-btn {
            transition: all 0.3s ease;
            cursor: pointer;
            border-bottom: 4px solid transparent;
        }
        .tab-btn.active {
            border-color: #4f46e5; /* Indigo 600 */
            color: #4f46e5;
            font-weight: 700;
        }
        .tab-pane {
            display: none;
        }
        .tab-pane.active {
            display: block;
        }
        .activity-card {
            background-color: white;
            border-radius: 1.5rem; /* 24px */
            padding: 2rem; /* 32px */
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.05);
            display: flex;
            flex-direction: column;
            min-height: 500px;
        }
        .btn-primary {
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; /* 12px */
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Indigo 700 */
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn-secondary {
            background-color: #e2e8f0; /* Slate 200 */
            color: #475569; /* Slate 600 */
        }
        .btn-secondary:hover {
            background-color: #cbd5e1; /* Slate 300 */
        }
        .btn-primary:disabled, .btn-secondary:disabled {
            background-color: #e2e8f0; /* Slate 200 */
            color: #94a3b8; /* Slate 400 */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .feedback {
            font-size: 1.125rem; /* 18px */
            font-weight: 700;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 1rem;
            text-align: center;
        }
        .feedback.correct {
            background-color: #dcfce7; /* Green 100 */
            color: #166534; /* Green 800 */
        }
        .feedback.incorrect {
            background-color: #fee2e2; /* Red 100 */
            color: #991b1b; /* Red 800 */
        }
        .feedback.warning {
            background-color: #fef9c3; /* Yellow 100 */
            color: #854d0e; /* Yellow 800 */
        }
        
        /* Interactive Array/Grid Multiplication */
        .interactive-grid-container { flex-grow: 1; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        #interactive-grid { display: grid; gap: 4px; }
        .grid-cell-placeholder { width: 24px; height: 24px; background-color: #e2e8f0; border-radius: 4px; transition: all 0.3s ease; }
        .grid-cell-filled { border: 2px solid rgba(0,0,0,0.1); transform: scale(1.1); }

        /* Number Name Matching Game */
        .matching-game { display: flex; justify-content: space-around; margin-top: 1rem; }
        .matching-column { display: flex; flex-direction: column; gap: 0.5rem; }
        .match-item { padding: 0.75rem; border: 2px solid #cbd5e1; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; text-align: center; font-weight: bold; }
        .match-item.selected { background-color: #60a5fa; color: white; border-color: #2563eb; }
        .match-item.matched { background-color: #4ade80; color: #15803d; border-color: #22c55e; cursor: not-allowed; opacity: 0.7; }
        .match-item.incorrect { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* Interactive Addition/Subtraction */
        .interactive-math-area { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        .source-area { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
        .source-box, .target-box { border: 3px dashed #a5b4fc; border-radius: 1rem; padding: 1rem; min-height: 120px; display: flex; flex-wrap: wrap; gap: 0.5rem; align-content: flex-start; }
        .target-box { border-color: #818cf8; background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M20 50 L80 50 M50 20 L50 80' stroke='%23e0e7ff' stroke-width='2'/%3E%3C/svg%3E"); width: 80%; position: relative; }
        .math-object { font-size: 2.5rem; cursor: pointer; transition: transform 0.2s, opacity 0.3s; }
        .math-object:hover { transform: scale(1.2); }
        .math-object.disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
        .target-box .math-object { cursor: default; }
        .target-box .math-object:hover { transform: none; }
        #basket-counter { position: absolute; bottom: 10px; right: 15px; font-size: 2rem; font-weight: bold; color: #4338ca; }
        .balloon { position: relative; font-size: 3rem; cursor: pointer; transition: transform 0.2s, opacity 0.5s; }
        .balloon.popped { transform: scale(1.5); opacity: 0; }

        /* Place Value Addition Machine */
        .addition-mat { display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; align-items: center; }
        .am-calculation { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; font-size: 3.5rem; font-weight: 700; line-height: 1.2; }
        .am-line { width: 100%; height: 3px; background-color: #1e293b; margin: 0.5rem 0; }
        .am-workspace { display: flex; flex-direction: column; gap: 0.5rem; }
        .am-workspace-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .am-workspace-col { padding: 0.5rem; border-radius: 1rem; background-color: #f8fafc; border: 1px solid #e2e8f0; }
        .am-workspace-header { text-align: center; font-weight: 700; color: #4f46e5; margin-bottom: 0.75rem; font-size: 1.125rem; }
        .am-blocks { display: flex; flex-wrap: wrap; gap: 4px; min-height: 100px; justify-content: center; align-items: center; width: 100%; padding: 0.5rem; border: 2px dashed #d1d5db; border-radius: 0.75rem; position: relative; }
        .am-result-area { border-top: 3px solid #1e293b; margin-top: 0.75rem; padding-top: 0.75rem; }
        .ten-rod { width: 12px; height: 50px; background-color: #60a5fa; border: 1px solid #2563eb; border-radius: 3px; transition: all 0.5s ease; }
        .one-cube { width: 12px; height: 12px; background-color: #fde047; border: 1px solid #ca8a04; border-radius: 3px; transition: all 0.5s ease; }
        .am-controls { display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1rem; grid-column: 1 / -1; }
        .am-controls button { width: 100%; }
        .am-result-value { font-size: 1.5rem; font-weight: bold; color: #166534; min-height: 2rem; text-align: center; margin-top: 0.5rem; }
        .carried-ten { background-color: #f97316 !important; border-color: #b45309 !important; z-index: 10; }
        .carry-box { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); width: 30px; height: 30px; border: 2px dashed #f97316; border-radius: 50%; display:flex; align-items:center; justify-content:center; }
        .grouping-box { border: 3px solid #f97316; padding: 4px; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; align-items: center; transition: all 0.5s ease-in-out; background: rgba(251, 146, 60, 0.1); }
        
        /* Drawing Pad */
        .drawing-toolbar { background-color: #e2e8f0; padding: 0.75rem; border-radius: 1rem; margin-bottom: 1rem; }
        #drawing-canvas { border: 2px solid #cbd5e1; border-radius: 1rem; cursor: crosshair; }
        .tool-btn, .color-swatch, .brush-size { width: 40px; height: 40px; border-radius: 0.5rem; cursor: pointer; border: 3px solid transparent; transition: all 0.2s; display:flex; align-items:center; justify-content:center; background-color: white; }
        .tool-btn.active, .color-swatch.active, .brush-size.active { border-color: #4f46e5; }
        .color-swatch { border-radius: 50%; }

        /* Mental Math */
        #mental-math-problem { font-size: 3rem; font-weight: 700; }
        
        /* Bar Graph */
        .bar-container { display: flex; align-items: flex-end; justify-content: space-around; height: 100%; min-height: 200px; border-left: 2px solid #6b7280; border-bottom: 2px solid #6b7280; padding: 0 1rem; background-color: #f8fafc; border-radius: 0.5rem; }
        .bar { width: 40px; background-color: #34d399; transition: height 0.5s ease-in-out; position: relative; }
        .bar-label { position: absolute; bottom: -25px; width: 100%; text-align: center; font-size: 0.8rem; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        <!-- Header Section -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-indigo-700">роХройрпНроп роЪроорпНрокрпВро░рпНрогро╛ родро┐роЯрпНроЯроорпН / роХройрпНропро╛ рокрпЖрогрпНроХро│рпН роХро▓рпНро╡ро┐ родро┐роЯрпНроЯроорпН</h1>
            <p class="text-base sm:text-lg md:text-xl mt-2 text-slate-600">роЗродрпНродро┐роЯрпНроЯроорпН TITAN рооро▒рпНро▒рпБроорпН KALIKE роиро┐ро▒рпБро╡ройроЩрпНроХро│ро┐ройрпН рокроЩрпНроХро│ро┐рокрпНрокрпБроЯройрпН роЪрпЖропро▓рпНрокроЯрпБродрпНродрокрпНрокроЯрпБроХро┐ро▒родрпБ</p>
            <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold text-orange-600 mt-6">роироЯрпБро╡рпБро▓ роХрпКроЮрпНроЪроорпН роХро▒рпНро▒ро▓рпИродрпН родрпЗроЯро┐</h2>
            <h3 class="text-xl sm:text-2xl md:text-3xl font-bold text-teal-600 mt-3">роХрогро┐родроорпН</h3>
            <p class="text-lg sm:text-xl md:text-2xl text-slate-500 mt-2">роЬрпВро▓рпИ - 1 ро╡родрпБ ро╡ро╛ро░роорпН</p>
        </header>

        <!-- Tabs Navigation -->
        <div id="tabs" class="flex justify-center border-b-2 border-slate-200 mb-8 gap-4 sm:gap-8">
            <button class="tab-btn active text-lg py-3 px-4" onclick="changeTab(event, 'tab1')">ро╡ро╛ропрпНроорпКро┤ро┐ рокропро┐ро▒рпНроЪро┐</button>
            <button class="tab-btn text-lg py-3 px-4" onclick="changeTab(event, 'tab2')">роХрогро┐род роЪрпЖропро▓рпНрокро╛роЯрпБроХро│рпН</button>
            <button class="tab-btn text-lg py-3 px-4" onclick="changeTab(event, 'tab3')">роХро▓рпНро╡ро┐роЪро╛ро░рпН роЪрпЖропро▓рпНрокро╛роЯрпБроХро│рпН</button>
        </div>

        <!-- Tab Content -->
        <div id="tab-content">
            <!-- Tab 1: ро╡ро╛ропрпНроорпКро┤ро┐ рокропро┐ро▒рпНроЪро┐ -->
            <div id="tab1" class="tab-pane active p-4">
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Multiplication Tables (Interactive Grid) -->
                    <div class="activity-card">
                        <h3 class="text-xl font-bold text-center mb-2 text-indigo-700">рокрпЖро░рпБроХрпНроХро▓рпН роХроЯрпНроЯроорпН</h3>
                        <p class="text-center text-sm mb-4 text-slate-500">роХрпБро┤рпБроХрпНроХро│рпИ роиро┐ро░рокрпНрокро┐ рокрпЖро░рпБроХрпНроХро▓рпИроХрпН роХро▒рпНроХро▓ро╛роорпН.</p>
                        <div class="flex justify-center items-center gap-4 my-4">
                            <select id="table-num-select" class="p-2 border rounded-lg" onchange="setupInteractiveGrid()">
                                <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option>
                            </select>
                            <span class="font-bold text-xl">x</span>
                            <select id="multiplier-select" class="p-2 border rounded-lg" onchange="setupInteractiveGrid()">
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
                                <option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
                            </select>
                        </div>
                        <div class="interactive-grid-container">
                            <div id="interactive-grid"></div>
                        </div>
                        <div id="grid-controls" class="text-center mt-auto">
                            <div id="grid-counter" class="h-8 text-lg font-bold text-blue-600"></div>
                            <button id="fill-btn" class="btn-primary bg-green-500 hover:bg-green-600" onclick="animateGridFill()">роиро┐ро░рокрпНрокрпБ</button>
                            <div id="multiplication-question" class="mt-4 hidden">
                                <input type="number" id="multiplication-answer" class="p-2 border rounded-lg text-2xl w-24 text-center" placeholder="?">
                                <button class="btn-primary ml-2" onclick="checkMultiplicationAnswer()">роЪро░ро┐рокро╛ро░рпНроХрпНроХро╡рпБроорпН</button>
                            </div>
                            <div id="multiplication-feedback" class="mt-2"></div>
                        </div>
                    </div>
                    <!-- Number Names (Matching Game) -->
                    <div class="activity-card">
                        <h3 class="text-xl font-bold text-center mb-4 text-indigo-700">роОрогрпН рокрпЖропро░рпНроХро│рпИрокрпН рокрпКро░рпБродрпНродрпБроХ</h3>
                        <p class="text-center text-sm mb-4 text-slate-500">роЪро░ро┐ропро╛рой роОрогрпНрогрпИ роЕродройрпН рокрпЖропро░рпБроЯройрпН рокрпКро░рпБродрпНродро╡рпБроорпН.</p>
                        <div id="matching-game-container" class="text-center flex-grow flex flex-col justify-center">
                            <div class="matching-game">
                                <div id="number-column" class="matching-column"></div>
                                <div id="name-column" class="matching-column"></div>
                            </div>
                            <div id="matching-feedback" class="mt-4 font-bold"></div>
                        </div>
                        <button class="btn-primary mt-4" onclick="setupNumberNameMatching()">рокрпБродро┐роп ро╡ро┐ро│рпИропро╛роЯрпНроЯрпБ</button>
                    </div>
                </div>
            </div>

            <!-- Tab 2: роХрогро┐род роЪрпЖропро▓рпНрокро╛роЯрпБроХро│рпН -->
            <div id="tab2" class="tab-pane p-4">
                 <div class="activity-card mb-6">
                    <div id="main-activity-content" class="text-center">
                        <h3 class="text-2xl font-bold text-center mb-6 text-indigo-700">роХрогро┐род роЪрпЖропро▓рпНрокро╛роЯрпБроХро│рпН</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <button class="btn-primary text-lg" onclick="loadActivity('add1')">1. роУро░ро┐ро▓роХрпНроХ роОрогрпНроХро│ро┐ройрпН роХрпВроЯрпБродро▓рпН</button>
                            <button class="btn-primary text-lg" onclick="loadActivity('sub1')">2. роУро░ро┐ро▓роХрпНроХ роОрогрпНроХро│ро┐ройрпН роХро┤ро┐родрпНродро▓рпН</button>
                            <button class="btn-primary text-lg" onclick="loadActivity('add2_no_carry')">3. роИро░ро┐ро▓роХрпНроХ роОрогрпНроХро│ро┐ройрпН роХрпВроЯрпБродро▓рпН (роЗройрооро╛ро▒рпНро▒рооро┐ройрпНро▒ро┐)</button>
                            <button class="btn-primary text-lg" onclick="loadActivity('add2_carry')">4. роИро░ро┐ро▓роХрпНроХ роОрогрпНроХро│ро┐ройрпН роХрпВроЯрпБродро▓рпН (роЗройрооро╛ро▒рпНро▒родрпНродрпБроЯройрпН)</button>
                        </div>
                    </div>
                     <div id="activity-container" class="mt-6"></div>
                 </div>
            </div>

            <!-- Tab 3: роХро▓рпНро╡ро┐роЪро╛ро░рпН роЪрпЖропро▓рпНрокро╛роЯрпБроХро│рпН -->
            <div id="tab3" class="tab-pane p-4">
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Shape Identifier -->
                    <div class="activity-card">
                        <h3 class="text-xl font-bold text-center mb-4 text-indigo-700">ро╡роЯро┐ро╡роЩрпНроХро│рпИроХрпН роХрогрпНроЯро▒ро┐родро▓рпН</h3>
                        <p class="text-center mb-2 text-slate-500">рокроЯродрпНродро┐ро▓рпН роЙро│рпНро│ <strong id="shape-to-find" class="text-red-500"></strong> ро╡роЯро┐ро╡рокрпН рокрпКро░рпБроЯрпНроХро│рпИроХрпН роХро┐ро│ро┐роХрпН роЪрпЖропрпНропро╡рпБроорпН.</p>
                        <div id="shape-scene" class="relative w-full h-64 bg-slate-200 rounded-lg overflow-hidden cursor-pointer"></div>
                        <div id="shape-feedback" class="text-center mt-2 font-bold"></div>
                        <button class="btn-primary mt-auto" onclick="setupShapeIdentifier()">ро╡рпЗро▒рпБрокроЯроорпН</button>
                    </div>
                    <!-- Drawing Pad -->
                    <div class="activity-card">
                        <h3 class="text-xl font-bold text-center mb-4 text-indigo-700">ро╡роЯро┐ро╡роЩрпНроХро│рпИ ро╡ро░рпИроХ</h3>
                        <p class="text-center mb-4 text-slate-500">роТро░рпБ роХро░рпБро╡ро┐ропрпИродрпН родрпЗро░рпНроирпНродрпЖроЯрпБродрпНродрпБ, роХрпЗройрпНро╡ро╛ро╕ро┐ро▓рпН ро╡ро░рпИропро╡рпБроорпН.</p>
                        <div class="drawing-toolbar flex justify-center items-center gap-2 flex-wrap">
                            <button class="tool-btn active" data-tool="pencil" onclick="setTool(this)"тЬПя╕П</button>
                            <button class="tool-btn" data-tool="circle" onclick="setTool(this)">тЪк</button>
                            <button class="tool-btn" data-tool="rectangle" onclick="setTool(this)">тмЬ</button>
                            <div class="color-swatch active" style="background-color: #000000;" data-color="#000000" onclick="changeColor(this)"></div>
                            <div class="color-swatch" style="background-color: #ef4444;" data-color="#ef4444" onclick="changeColor(this)"></div>
                            <div class="color-swatch" style="background-color: #3b82f6;" data-color="#3b82f6" onclick="changeColor(this)"></div>
                            <div class="color-swatch" style="background-color: #22c55e;" data-color="#22c55e" onclick="changeColor(this)"></div>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="fill-shape-check"><span>роиро┐ро░рокрпНрокрпБ</span></label>
                            <button class="btn-secondary text-sm py-2 px-4" onclick="clearCanvas()">роЕро┤ро┐</button>
                        </div>
                        <canvas id="drawing-canvas" class="w-full flex-grow bg-white mt-4" width="400" height="300"></canvas>
                    </div>
                    <!-- Bar Graph -->
                     <div class="activity-card">
                        <h3 class="text-xl font-bold text-center mb-4 text-indigo-700">рокроЯрпНроЯрпИ ро╡ро░рпИрокроЯроорпН</h3>
                        <p class="text-center mb-4 text-slate-500">роХрпКроЯрпБроХрпНроХрокрпНрокроЯрпНроЯ родро░ро╡рпБроХро│рпБроХрпНроХрпБ рокроЯрпНроЯрпИ ро╡ро░рпИрокроЯроорпН ро╡ро░рпИропро╡рпБроорпН.</p>
                        <div class="grid grid-cols-3 gap-4 mb-4">
                           <div><label for="bar1">роЖрокрпНрокро┐ро│рпН:</label><input type="number" id="bar1" class="w-full border rounded-lg p-2" value="5" min="0" max="10" oninput="updateBarGraph()"></div>
                           <div><label for="bar2">роЖро░роЮрпНроЪрпБ:</label><input type="number" id="bar2" class="w-full border rounded-lg p-2" value="8" min="0" max="10" oninput="updateBarGraph()"></div>
                           <div><label for="bar3">ро╡ро╛ро┤рпИ:</label><input type="number" id="bar3" class="w-full border rounded-lg p-2" value="3" min="0" max="10" oninput="updateBarGraph()"></div>
                        </div>
                        <div class="bar-container flex-grow">
                           <div class="bar" id="bar-graph-1"><div class="bar-label">роЖрокрпНрокро┐ро│рпН</div></div>
                           <div class="bar" id="bar-graph-2" style="background-color: #f97316;"><div class="bar-label">роЖро░роЮрпНроЪрпБ</div></div>
                           <div class="bar" id="bar-graph-3" style="background-color: #facc15;"><div class="bar-label">ро╡ро╛ро┤рпИ</div></div>
                        </div>
                     </div>
                     <!-- Mental Math -->
                     <div class="activity-card text-center flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-indigo-700">рооройроХрпН роХрогроХрпНроХрпБ</h3>
                            <span id="mental-math-question-counter" class="text-sm font-bold bg-indigo-100 text-indigo-800 py-1 px-3 rounded-full"></span>
                        </div>
                        <div class="flex-grow flex flex-col justify-center">
                            <p class="text-center mb-6 text-slate-500">ро╡ро┐ро░рпИро╡ро╛роХ рокродро┐ро▓ро│ро┐роХрпНроХро╡рпБроорпН!</p>
                            <div id="mental-math-problem" class="text-slate-800"></div>
                            <input type="number" id="mental-math-answer" class="p-2 border rounded-lg text-2xl w-32 text-center mx-auto my-4" placeholder="?">
                            <div id="mental-math-feedback" class="mt-4"></div>
                        </div>
                        <div class="text-center mt-auto pt-6 flex justify-center items-center gap-4">
                           <button class="btn-primary btn-secondary" id="mental-math-prev" onclick="loadPreviousMentalProblem()">роорпБроирпНродрпИроп роХрпЗро│рпНро╡ро┐</button>
                           <button class="btn-primary" id="mental-math-check" onclick="checkMentalMathAnswer()">роЪро░ро┐рокро╛ро░рпНроХрпНроХро╡рпБроорпН</button>
                           <button class="btn-primary" id="mental-math-next" onclick="loadNextMentalProblem()">роЕроЯрпБродрпНрод роХрпЗро│рпНро╡ро┐</button>
                        </div>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global State & Data ---
        const numberNamesData = { 1: "роТройрпНро▒рпБ", 2: "роЗро░рогрпНроЯрпБ", 3: "роорпВройрпНро▒рпБ", 4: "роиро╛ройрпНроХрпБ", 5: "роРроирпНродрпБ", 6: "роЖро▒рпБ", 7: "роПро┤рпБ", 8: "роОроЯрпНроЯрпБ", 9: "роТройрпНрокродрпБ", 10: "рокродрпНродрпБ", 11: "рокродро┐ройрпКройрпНро▒рпБ", 12: "рокройрпНройро┐ро░рогрпНроЯрпБ", 13: "рокродро┐роорпВройрпНро▒рпБ", 14: "рокродро┐ройро╛ройрпНроХрпБ", 15: "рокродро┐ройрпИроирпНродрпБ", 16: "рокродро┐ройро╛ро▒рпБ", 17: "рокродро┐ройрпЗро┤рпБ", 18: "рокродро┐ройрпЖроЯрпНроЯрпБ", 19: "рокродрпНродрпКройрпНрокродрпБ", 20: "роЗро░рпБрокродрпБ" };
        const shapes = [ { name: 'ро╡роЯрпНроЯроорпН', style: 'width:50px; height:50px; background: #ef4444; border-radius: 50%; top: 20%; left: 15%;' }, { name: 'роЪродрпБро░роорпН', style: 'width:60px; height:60px; background: #3b82f6; top: 50%; left: 30%;' }, { name: 'роЪрпЖро╡рпНро╡роХроорпН', style: 'width:80px; height:40px; background: #22c55e; top: 65%; left: 60%;' }, { name: 'роорпБроХрпНроХрпЛрогроорпН', style: 'width: 0; height: 0; border-left: 30px solid transparent; border-right: 30px solid transparent; border-bottom: 60px solid #f97316; top: 10%; left: 70%;' }, { name: 'ро╡роЯрпНроЯроорпН', style: 'width:30px; height:30px; background: #ef4444; border-radius: 50%; top: 75%; left: 10%;' }, { name: 'роЪродрпБро░роорпН', style: 'width:40px; height:40px; background: #3b82f6; top: 15%; left: 45%;' } ];
        const groupColors = ['#60a5fa', '#f87171', '#4ade80', '#fbbf24', '#a78bfa', '#22d3ee', '#f472b6', '#818cf8', '#34d399', '#f97316'];
        let currentShapeToFind = '';
        let selectedNumber = null, selectedName = null, matchedPairs = 0;
        const pairsToMatch = 5;

        // Problem sets for all categories
        const additionProblems = [ {n1: 1, n2: 1}, {n1: 1, n2: 2}, {n1: 1, n2: 3}, {n1: 1, n2: 4}, {n1: 1, n2: 5}, {n1: 1, n2: 6}, {n1: 1, n2: 7}, {n1: 1, n2: 8}, {n1: 2, n2: 2}, {n1: 2, n2: 3}, {n1: 2, n2: 4}, {n1: 2, n2: 5}, {n1: 2, n2: 6}, {n1: 2, n2: 7}, {n1: 3, n2: 3}, {n1: 3, n2: 4}, {n1: 3, n2: 5}, {n1: 3, n2: 6}, {n1: 4, n2: 4}, {n1: 4, n2: 5}, {n1: 5, n2: 5}, {n1: 2, n2: 1}, {n1: 3, n2: 1}, {n1: 3, n2: 2}, {n1: 4, n2: 1}, {n1: 4, n2: 2}, {n1: 4, n2: 3}, {n1: 5, n2: 1}, {n1: 5, n2: 2}, {n1: 5, n2: 3}, {n1: 5, n2: 4}, {n1: 6, n2: 1}, {n1: 6, n2: 2}, {n1: 6, n2: 3}, {n1: 6, n2: 4}, {n1: 6, n2: 5}, {n1: 7, n2: 1}, {n1: 7, n2: 2}, {n1: 7, n2: 3}, {n1: 8, n2: 1}, {n1: 8, n2: 2}, {n1: 9, n2: 1}, {n1: 7, n2: 5}, {n1: 8, n2: 4}, {n1: 9, n2: 3}, {n1: 6, n2: 7}, {n1: 5, n2: 8}, {n1: 4, n2: 9}, {n1: 3, n2: 8}, {n1: 2, n2: 9}, {n1: 9, n2: 4}, {n1: 8, n2: 5}, {n1: 7, n2: 6} ];
        const subtractionProblems = [ {n1: 2, n2: 1}, {n1: 3, n2: 1}, {n1: 3, n2: 2}, {n1: 4, n2: 1}, {n1: 4, n2: 2}, {n1: 4, n2: 3}, {n1: 5, n2: 1}, {n1: 5, n2: 2}, {n1: 5, n2: 3}, {n1: 5, n2: 4}, {n1: 6, n2: 1}, {n1: 6, n2: 2}, {n1: 6, n2: 3}, {n1: 6, n2: 4}, {n1: 6, n2: 5}, {n1: 7, n2: 1}, {n1: 7, n2: 2}, {n1: 7, n2: 3}, {n1: 7, n2: 4}, {n1: 7, n2: 5}, {n1: 7, n2: 6}, {n1: 8, n2: 1}, {n1: 8, n2: 2}, {n1: 8, n2: 3}, {n1: 8, n2: 4}, {n1: 8, n2: 5}, {n1: 8, n2: 6}, {n1: 8, n2: 7}, {n1: 9, n2: 1}, {n1: 9, n2: 2}, {n1: 9, n2: 3}, {n1: 9, n2: 4}, {n1: 9, n2: 5}, {n1: 9, n2: 6}, {n1: 9, n2: 7}, {n1: 9, n2: 8}, {n1: 9, n2: 0}, {n1: 8, n2: 0}, {n1: 7, n2: 0}, {n1: 6, n2: 0}, {n1: 5, n2: 0}, {n1: 4, n2: 0}, {n1: 3, n2: 0}, {n1: 2, n2: 0}, {n1: 1, n2: 0}, {n1: 1, n2: 1}, {n1: 2, n2: 2}, {n1: 3, n2: 3}, {n1: 4, n2: 4}, {n1: 5, n2: 5}, {n1: 6, n2: 6}, {n1: 7, n2: 7}, {n1: 8, n2: 8}, {n1: 9, n2: 9} ];
        const add2DigitNoCarryProblems = Array.from({length: 50}, () => { let n1, n2; do { n1 = Math.floor(Math.random() * 90) + 10; n2 = Math.floor(Math.random() * 90) + 10; } while ((n1 % 10) + (n2 % 10) >= 10 || n1 + n2 >= 100); return {n1, n2}; });
        const add2DigitWithCarryProblems = Array.from({length: 50}, () => { let n1, n2; do { n1 = Math.floor(Math.random() * 90) + 10; n2 = Math.floor(Math.random() * 90) + 10; } while ((n1 % 10) + (n2 % 10) < 10 || n1 + n2 >= 100); return {n1, n2}; });
        const mentalMathProblems = [
            ...additionProblems.slice(0, 5).map(p => ({...p, type: 'add1', answer: p.n1 + p.n2})),
            ...subtractionProblems.slice(0, 5).map(p => ({...p, type: 'sub1', answer: p.n1 - p.n2})),
            ...add2DigitNoCarryProblems.slice(0, 5).map(p => ({...p, type: 'add2_no_carry', answer: p.n1 + p.n2})),
            ...add2DigitWithCarryProblems.slice(0, 5).map(p => ({...p, type: 'add2_carry', answer: p.n1 + p.n2}))
        ];
        
        // State for math quiz
        let currentProblemSet = [];
        let currentProblemIndex = 0;
        let currentActivityType = null;
        let currentMentalMathProblemIndex = 0;

        // --- Tab Management ---
        function changeTab(event, tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(tabId === 'tab2') {
                showMainMenu();
            } else if (tabId === 'tab3') {
                setupDrawingPad();
                renderMentalMathProblem();
                setupShapeIdentifier();
                updateBarGraph();
            }
        }

        // --- Tab 1: ро╡ро╛ропрпНроорпКро┤ро┐ рокропро┐ро▒рпНроЪро┐ ---
        function setupInteractiveGrid() {
            const gridContainer = document.getElementById('interactive-grid');
            if(!gridContainer) return;
            const questionDiv = document.getElementById('multiplication-question');
            const fillBtn = document.getElementById('fill-btn');
            const feedbackDiv = document.getElementById('multiplication-feedback');
            const counterDiv = document.getElementById('grid-counter');
            const tableSelect = document.getElementById('table-num-select');
            const multiplierSelect = document.getElementById('multiplier-select');

            tableSelect.disabled = false;
            multiplierSelect.disabled = false;

            const rows = parseInt(tableSelect.value);
            const cols = parseInt(multiplierSelect.value);
            gridContainer.innerHTML = '';
            gridContainer.style.gridTemplateColumns = `repeat(${cols}, 24px)`;
            gridContainer.style.gridTemplateRows = `repeat(${rows}, 24px)`;
            for (let i = 0; i < rows * cols; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell-placeholder';
                cell.id = `cell-${i}`;
                gridContainer.appendChild(cell);
            }
            questionDiv.classList.add('hidden');
            fillBtn.disabled = false;
            feedbackDiv.innerHTML = '';
            counterDiv.innerHTML = '';
            document.getElementById('multiplication-answer').value = '';
        }
        function animateGridFill() {
            const fillBtn = document.getElementById('fill-btn');
            const questionDiv = document.getElementById('multiplication-question');
            const counterDiv = document.getElementById('grid-counter');
            const tableSelect = document.getElementById('table-num-select');
            const multiplierSelect = document.getElementById('multiplier-select');
            
            tableSelect.disabled = true;
            multiplierSelect.disabled = true;
            fillBtn.disabled = true;

            const rows = parseInt(tableSelect.value);
            const cols = parseInt(multiplierSelect.value);
            let currentRow = 0;
            function fillRow() {
                if (currentRow >= rows) {
                    questionDiv.classList.remove('hidden');
                    counterDiv.textContent = `роорпКродрпНродроорпН: ${rows * cols}`;
                    return;
                }
                const rowColor = groupColors[currentRow % groupColors.length];
                for (let i = 0; i < cols; i++) {
                    const cellIndex = currentRow * cols + i;
                    const cell = document.getElementById(`cell-${cellIndex}`);
                    setTimeout(() => {
                        cell.classList.add('grid-cell-filled');
                        cell.style.backgroundColor = rowColor;
                    }, i * 60);
                }
                currentRow++;
                counterDiv.textContent = `${currentRow} роХрпБро┤рпБ (${currentRow * cols})`;
                setTimeout(fillRow, 700);
            }
            fillRow();
        }
        function checkMultiplicationAnswer() {
            const feedbackDiv = document.getElementById('multiplication-feedback');
            const tableNum = parseInt(document.getElementById('table-num-select').value);
            const multiplier = parseInt(document.getElementById('multiplier-select').value);
            const correctAnswer = tableNum * multiplier;
            const userAnswer = parseInt(document.getElementById('multiplication-answer').value);
            if (userAnswer === correctAnswer) {
                feedbackDiv.innerHTML = `<div class="feedback correct">рооро┐роХроЪрпН роЪро░ро┐! ${tableNum} x ${multiplier} = ${correctAnswer}</div>`;
            } else {
                feedbackDiv.innerHTML = `<div class="feedback incorrect">родро╡ро▒рпБ. роЪро░ро┐ропро╛рой рокродро┐ро▓рпН ${correctAnswer}. роорпАрогрпНроЯрпБроорпН роорпБропро▒рпНроЪро┐ роЪрпЖропрпН!</div>`;
            }
            setTimeout(setupInteractiveGrid, 2000);
        }
        function setupNumberNameMatching() {
            const numberColumn = document.getElementById('number-column');
            if(!numberColumn) return;
            const nameColumn = document.getElementById('name-column');
            const feedbackEl = document.getElementById('matching-feedback');
            numberColumn.innerHTML = ''; nameColumn.innerHTML = '';
            feedbackEl.textContent = ''; matchedPairs = 0;
            const allNumbers = Object.keys(numberNamesData);
            const shuffledNumbers = allNumbers.sort(() => 0.5 - Math.random());
            const selectedNumbers = shuffledNumbers.slice(0, pairsToMatch);
            const selectedNames = selectedNumbers.map(num => numberNamesData[num]);
            const shuffledNames = selectedNames.sort(() => 0.5 - Math.random());
            selectedNumbers.forEach(num => {
                const item = document.createElement('div');
                item.className = 'match-item'; item.textContent = num;
                item.dataset.value = num; item.onclick = () => selectItem(item, 'number');
                numberColumn.appendChild(item);
            });
            shuffledNames.forEach(name => {
                const item = document.createElement('div');
                item.className = 'match-item'; item.textContent = name;
                item.dataset.value = name; item.onclick = () => selectItem(item, 'name');
                nameColumn.appendChild(item);
            });
        }
        function selectItem(element, type) {
            if (element.classList.contains('matched')) return;
            if (type === 'number') {
                if (selectedNumber) selectedNumber.classList.remove('selected');
                selectedNumber = element; selectedNumber.classList.add('selected');
            } else {
                if (selectedName) selectedName.classList.remove('selected');
                selectedName = element; selectedName.classList.add('selected');
            }
            if (selectedNumber && selectedName) checkMatch();
        }
        function checkMatch() {
            const numValue = selectedNumber.dataset.value;
            const nameValue = selectedName.dataset.value;
            const feedbackEl = document.getElementById('matching-feedback');
            if (numberNamesData[numValue] === nameValue) {
                selectedNumber.classList.add('matched'); selectedName.classList.add('matched');
                selectedNumber.classList.remove('selected'); selectedName.classList.remove('selected');
                selectedNumber = null; selectedName = null;
                matchedPairs++;
                if (matchedPairs === pairsToMatch) {
                    feedbackEl.textContent = 'роЕро░рпБроорпИ! роЕройрпИродрпНродрпИропрпБроорпН роЪро░ро┐ропро╛роХрокрпН рокрпКро░рпБродрпНродро┐ро╡ро┐роЯрпНроЯрпАро░рпНроХро│рпН!';
                    feedbackEl.className = 'mt-4 font-bold text-green-600';
                }
            } else {
                selectedNumber.classList.add('incorrect'); selectedName.classList.add('incorrect');
                feedbackEl.textContent = 'родро╡ро▒ро╛рой рокрпКро░рпБродрпНродроорпН, роорпАрогрпНроЯрпБроорпН роорпБропро▒рпНроЪро┐роХрпНроХро╡рпБроорпН.';
                feedbackEl.className = 'mt-4 font-bold text-red-600';
                setTimeout(() => {
                    selectedNumber.classList.remove('incorrect', 'selected');
                    selectedName.classList.remove('incorrect', 'selected');
                    selectedNumber = null; selectedName = null;
                    feedbackEl.textContent = '';
                }, 1000);
            }
        }


        // --- Tab 2 (IMPROVED with Navigation and Randomization) ---
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function loadActivity(activityId) {
            document.getElementById('main-activity-content').style.display = 'none';
            switch(activityId) {
                case 'add1': 
                    currentActivityType = 'add1';
                    currentProblemSet = shuffleArray([...additionProblems]);
                    break;
                case 'sub1': 
                    currentActivityType = 'sub1';
                    currentProblemSet = shuffleArray([...subtractionProblems]);
                    break;
                case 'add2_no_carry': 
                    currentActivityType = 'add2_no_carry';
                    currentProblemSet = shuffleArray([...add2DigitNoCarryProblems]);
                    break;
                case 'add2_carry': 
                    currentActivityType = 'add2_carry';
                    currentProblemSet = shuffleArray([...add2DigitWithCarryProblems]);
                    break;
            }
            currentProblemIndex = 0;
            renderProblem();
        }

        function renderProblem() {
            const container = document.getElementById('activity-container');
            if(!container) return;
            if (currentProblemIndex >= currentProblemSet.length) {
                container.innerHTML = `<div class="text-lg font-bold text-green-600 p-4 text-center">роЕро░рпБроорпИ! роЗроирпНрод роЪрпЖропро▓рпНрокро╛роЯрпНроЯро┐ро▓рпН роЙро│рпНро│ роЕройрпИродрпНродрпБ роХрпЗро│рпНро╡ро┐роХро│рпИропрпБроорпН роорпБроЯро┐родрпНродрпБро╡ро┐роЯрпНроЯрпАро░рпНроХро│рпН!</div>`;
                return;
            }

            const problem = currentProblemSet[currentProblemIndex];
            const isAddition = currentActivityType.includes('add');
            const isTwoDigit = currentActivityType.includes('2');
            
            let title, problemText, answer, gameHTML;

            if (isTwoDigit) {
                title = currentActivityType === 'add2_no_carry' ? 'роИро░ро┐ро▓роХрпНроХ роХрпВроЯрпБродро▓рпН (роЗройрооро╛ро▒рпНро▒рооро┐ройрпНро▒ро┐)' : 'роИро░ро┐ро▓роХрпНроХ роХрпВроЯрпБродро▓рпН (роЗройрооро╛ро▒рпНро▒родрпНродрпБроЯройрпН)';
                problemText = ''; // Problem is shown in the machine itself
                answer = problem.n1 + problem.n2;
                gameHTML = getAdditionMatHTML(problem);
            } else { // Single digit
                title = isAddition ? 'рокро┤роХрпНроХрпВроЯрпИ ро╡ро┐ро│рпИропро╛роЯрпНроЯрпБ (роХрпВроЯрпНроЯро▓рпН)' : 'рокро▓рпВройрпН роЙроЯрпИроХрпНроХрпБроорпН ро╡ро┐ро│рпИропро╛роЯрпНроЯрпБ (роХро┤ро┐родрпНродро▓рпН)';
                problemText = isAddition ? `${problem.n1} + ${problem.n2} = ?` : `${problem.n1} - ${problem.n2} = ?`;
                const instructions = isAddition ? 'рокро┤роЩрпНроХро│рпИродрпН родрпКроЯрпНроЯрпБроХрпН роХрпВроЯрпИропро┐ро▓рпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН.' : `${problem.n2} рокро▓рпВройрпНроХро│рпИродрпН родрпКроЯрпНроЯрпБ роЙроЯрпИроХрпНроХро╡рпБроорпН.`;
                answer = isAddition ? problem.n1 + problem.n2 : problem.n1 - problem.n2;
                gameHTML = `<p class="text-center mb-4">${instructions}</p>` + (isAddition ? getAdditionHTML(problem) : getSubtractionHTML(problem));
            }

            container.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-xl font-bold text-indigo-700">${title}</h4>
                    <span class="text-sm font-bold bg-indigo-100 text-indigo-800 py-1 px-3 rounded-full">роХрпЗро│рпНро╡ро┐ ${currentProblemIndex + 1} / ${currentProblemSet.length}</span>
                </div>
                <div class="flex justify-center items-center text-4xl font-bold mb-4">${problemText}</div>
                ${gameHTML}
                <div id="simple-math-feedback" class="mt-4"></div>
                <div class="text-center mt-auto pt-6 flex justify-center items-center gap-4">
                    <button class="btn-primary btn-secondary" onclick="loadPreviousProblem()" ${currentProblemIndex === 0 ? 'disabled' : ''}>роорпБроирпНродрпИроп роХрпЗро│рпНро╡ро┐</button>
                    <div id="answer-section">
                        <input type="number" id="user-answer" class="p-2 border rounded-lg text-2xl w-24 text-center" placeholder="?">
                        <button class="btn-primary ml-2" onclick="checkAnswer(${answer})">роЪро░ро┐рокро╛ро░рпНроХрпНроХро╡рпБроорпН</button>
                    </div>
                    <button class="btn-primary" onclick="loadNextProblem()" ${currentProblemIndex === currentProblemSet.length - 1 ? 'disabled' : ''}>роЕроЯрпБродрпНрод роХрпЗро│рпНро╡ро┐</button>
                </div>
            `;
            
            if (!isTwoDigit) {
                if (isAddition) attachAdditionListeners(problem);
                else attachSubtractionListeners(problem);
            }
        }
        
        function showMainMenu() {
            const container = document.getElementById('activity-container');
            const menu = document.getElementById('main-activity-content');
            if(container) container.innerHTML = '';
            if(menu) menu.style.display = 'block';
        }

        function getAdditionHTML(problem) {
            return `<div class="interactive-math-area"><div class="source-area"><div class="source-box" id="source1"></div><div class="source-box" id="source2"></div></div><div class="target-box" id="basket"><span id="basket-counter">0</span></div></div>`;
        }
        
        function attachAdditionListeners(problem) {
            const source1 = document.getElementById('source1');
            for(let i=0; i<problem.n1; i++) {
                const el = document.createElement('div'); el.className = 'math-object'; el.textContent = 'ЁЯНО'; el.onclick = moveObject; source1.appendChild(el);
            }
            const source2 = document.getElementById('source2');
            for(let i=0; i<problem.n2; i++) {
                const el = document.createElement('div'); el.className = 'math-object'; el.textContent = 'ЁЯНК'; el.onclick = moveObject; source2.appendChild(el);
            }
        }
        
        function getSubtractionHTML(problem) {
             return `<div class="interactive-math-area"><div class="source-box justify-center" id="balloon-box"></div></div>`;
        }

        function attachSubtractionListeners(problem) {
            const balloonBox = document.getElementById('balloon-box');
            let poppedCount = 0;
            for (let i = 0; i < problem.n1; i++) {
                const el = document.createElement('div'); el.className = 'balloon'; el.textContent = 'ЁЯОИ';
                el.onclick = () => { if (poppedCount < problem.n2) { el.classList.add('popped'); el.style.pointerEvents = 'none'; poppedCount++; } };
                balloonBox.appendChild(el);
            }
        }
        
        function getAdditionMatHTML(problem) {
             const {n1, n2} = problem;
             const tens1 = Math.floor(n1 / 10), ones1 = n1 % 10;
             const tens2 = Math.floor(n2 / 10), ones2 = n2 % 10;
             const hasCarry = (ones1 + ones2) >= 10;

             return `<div class="addition-mat" id="am-machine">
                        <div class="am-calculation">
                            <div>${n1}</div>
                            <div>+ ${n2}</div>
                            <div class="am-line"></div>
                            <div id="am-calc-result" class="text-gray-400">?</div>
                        </div>
                        <div class="am-workspace">
                            <div class="am-workspace-row">
                                <div class="am-workspace-col"><div class="am-workspace-header">рокродрпНродрпБроХро│рпН</div><div class="am-blocks" id="am-tens-start">${Array(tens1).fill('<div class="ten-rod"></div>').join('')}${Array(tens2).fill('<div class="ten-rod" style="background-color: #84cc16;"></div>').join('')}</div></div>
                                <div class="am-workspace-col"><div class="am-workspace-header">роТройрпНро▒рпБроХро│рпН</div><div class="am-blocks" id="am-ones-start">${Array(ones1).fill('<div class="one-cube"></div>').join('')}${Array(ones2).fill('<div class="one-cube" style="background-color: #a3e635;"></div>').join('')}</div></div>
                            </div>
                            <div class="am-workspace-row am-result-area">
                                <div class="am-workspace-col relative"><div class="carry-box" id="am-carry-box"></div><div class="am-blocks" id="am-tens-result"></div><div id="am-tens-value" class="am-result-value"></div></div>
                                <div class="am-workspace-col"><div class="am-blocks" id="am-ones-result"></div><div id="am-ones-value" class="am-result-value"></div></div>
                            </div>
                        </div>
                        <div class="am-controls col-span-2" id="pvm-controls">
                            <button class="btn-primary" id="pvm-step1" onclick="am_step1_add_ones()">рокроЯро┐ 1: роТройрпНро▒рпБроХро│рпИроЪрпН роЪрпЗро░рпН</button>
                            <button class="btn-primary" id="pvm-step2" onclick="am_step2_carry_over()" style="display: none;" ${!hasCarry ? 'disabled' : ''}>рокроЯро┐ 2: роЗройрооро╛ро▒рпНро▒роорпН роЪрпЖропрпН</button>
                            <button class="btn-primary" id="pvm-step3" onclick="am_step3_add_tens()" style="display: none;">рокроЯро┐ ${hasCarry ? 3 : 2}: рокродрпНродрпБроХро│рпИроЪрпН роЪрпЗро░рпН</button>
                        </div>
                    </div>`;
        }

        function am_step1_add_ones() {
            const startOnes = document.getElementById('am-ones-start');
            const resultOnes = document.getElementById('am-ones-result');
            const resultOnesValue = document.getElementById('am-ones-value');
            
            Array.from(startOnes.children).forEach(child => resultOnes.appendChild(child));
            startOnes.innerHTML = '';
            resultOnesValue.textContent = resultOnes.children.length;

            document.getElementById('pvm-step1').disabled = true;
            document.getElementById('pvm-step2').style.display = 'block';
            document.getElementById('pvm-step3').style.display = 'block';
        }

        function am_step2_carry_over() {
            const step2Btn = document.getElementById('pvm-step2');
            step2Btn.disabled = true;

            const resultOnes = document.getElementById('am-ones-result');
            const carryBox = document.getElementById('am-carry-box');
            const resultOnesValue = document.getElementById('am-ones-value');
            const cubes = Array.from(resultOnes.children);

            if (cubes.length >= 10) {
                const cubesToCarry = cubes.slice(0, 10);
                
                const group = document.createElement('div');
                group.className = 'grouping-box';
                cubesToCarry.forEach(cube => group.appendChild(cube));
                resultOnes.prepend(group);

                setTimeout(() => {
                    group.style.transform = 'scale(0)';
                    group.style.opacity = '0';
                    setTimeout(() => {
                        group.remove();
                        const newTenRod = document.createElement('div');
                        newTenRod.className = 'ten-rod carried-ten';
                        newTenRod.style.position = 'absolute';
                        const resultOnesRect = resultOnes.getBoundingClientRect();
                        const machineRect = document.getElementById('am-machine').getBoundingClientRect();
                        newTenRod.style.top = `${resultOnesRect.top - machineRect.top + (resultOnesRect.height / 2) - 30}px`;
                        newTenRod.style.left = `${resultOnesRect.left - machineRect.left + (resultOnesRect.width / 2) - 7}px`;
                        document.getElementById('am-machine').appendChild(newTenRod);
                        
                        setTimeout(() => {
                            const carryBoxRect = carryBox.getBoundingClientRect();
                            newTenRod.style.top = `${carryBoxRect.top - machineRect.top + 4}px`;
                            newTenRod.style.left = `${carryBoxRect.left - machineRect.left + 4}px`;
                            setTimeout(() => {
                                newTenRod.remove();
                                carryBox.appendChild(newTenRod);
                                newTenRod.style.position = 'static';
                                resultOnesValue.textContent = resultOnes.children.length;
                            }, 600);
                        }, 100);

                    }, 500);
                }, 800);
            }
        }

        function am_step3_add_tens() {
            const startTens = document.getElementById('am-tens-start');
            const resultTens = document.getElementById('am-tens-result');
            const resultTensValue = document.getElementById('am-tens-value');
            const carryBox = document.getElementById('am-carry-box');
            
            Array.from(carryBox.children).forEach(rod => resultTens.appendChild(rod));
            Array.from(startTens.children).forEach(rod => resultTens.appendChild(rod));

            startTens.innerHTML = '';
            resultTensValue.textContent = resultTens.children.length;
            
            document.getElementById('pvm-step3').disabled = true;
        }

        function moveObject(event) {
            const obj = event.currentTarget;
            obj.classList.add('disabled');
            const basket = document.getElementById('basket');
            const newObj = obj.cloneNode(true);
            newObj.classList.remove('disabled');
            basket.appendChild(newObj);
            const counter = document.getElementById('basket-counter');
            counter.textContent = basket.children.length - 1;
        }

        function checkAnswer(correctAnswer) {
            const userAnswerEl = document.getElementById('user-answer');
            const feedbackEl = document.getElementById('simple-math-feedback');
            
            if (userAnswerEl.value === '') {
                feedbackEl.innerHTML = `<div class="feedback warning">родропро╡рпБроЪрпЖропрпНродрпБ роТро░рпБ ро╡ро┐роЯрпИропрпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН.</div>`;
                return;
            }

            const userAnswer = parseInt(userAnswerEl.value);
            if (userAnswer === correctAnswer) {
                feedbackEl.innerHTML = `<div class="feedback correct">роЪро░ро┐ропро╛рой рокродро┐ро▓рпН!</div>`;
                if(document.getElementById('am-calc-result')) {
                    document.getElementById('am-calc-result').textContent = correctAnswer;
                    document.getElementById('am-calc-result').classList.remove('text-gray-400');
                    document.getElementById('am-calc-result').classList.add('text-green-600');
                }
            } else {
                feedbackEl.innerHTML = `<div class="feedback incorrect">родро╡ро▒рпБ. роЪро░ро┐ропро╛рой рокродро┐ро▓рпН ${correctAnswer}.</div>`;
            }
        }
        
        function loadNextProblem() {
            if (currentProblemIndex < currentProblemSet.length - 1) {
                currentProblemIndex++;
                renderProblem();
            }
        }
        
        function loadPreviousProblem() {
            if (currentProblemIndex > 0) {
                currentProblemIndex--;
                renderProblem();
            }
        }

        // --- Tab 3 ---
        function setupShapeIdentifier() {
            const scene = document.getElementById('shape-scene');
            if(!scene) return;
            const shapeToFindEl = document.getElementById('shape-to-find');
            const feedbackEl = document.getElementById('shape-feedback');
            scene.innerHTML = ''; feedbackEl.textContent = '';
            const shapeNames = [...new Set(shapes.map(s => s.name))];
            currentShapeToFind = shapeNames[Math.floor(Math.random() * shapeNames.length)];
            shapeToFindEl.textContent = currentShapeToFind;
            shapes.forEach(shape => {
                const el = document.createElement('div');
                el.className = 'absolute cursor-pointer transition-transform hover:scale-110';
                el.style.cssText = shape.style; el.dataset.shapeName = shape.name;
                el.onclick = () => {
                    if (el.dataset.shapeName === currentShapeToFind) {
                        el.style.border = '4px solid #10b981';
                        feedbackEl.textContent = 'роЪро░ро┐ропро╛роХроХрпН роХрогрпНроЯрпБрокро┐роЯро┐родрпНродрпАро░рпНроХро│рпН!';
                        feedbackEl.className = 'text-center mt-2 font-bold text-green-600';
                    } else {
                         feedbackEl.textContent = 'родро╡ро▒рпБ, роорпАрогрпНроЯрпБроорпН роорпБропро▒рпНроЪро┐роХрпНроХро╡рпБроорпН!';
                         feedbackEl.className = 'text-center mt-2 font-bold text-red-600';
                    }
                };
                scene.appendChild(el);
            });
        }
        function updateBarGraph() {
            const val1 = document.getElementById('bar1').value || 0, val2 = document.getElementById('bar2').value || 0, val3 = document.getElementById('bar3').value || 0;
            const maxValue = 10;
            document.getElementById('bar-graph-1').style.height = `${(val1 / maxValue) * 100}%`;
            document.getElementById('bar-graph-2').style.height = `${(val2 / maxValue) * 100}%`;
            document.getElementById('bar-graph-3').style.height = `${(val3 / maxValue) * 100}%`;
        }
        
        // Drawing Pad
        let canvas, ctx, drawing = false, currentColor = '#000000', currentTool = 'pencil', startX, startY;
        function setupDrawingPad() {
            canvas = document.getElementById('drawing-canvas');
            if(!canvas) return;
            ctx = canvas.getContext('2d');
            ctx.strokeStyle = currentColor;
            ctx.fillStyle = currentColor;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';

            canvas.addEventListener('mousedown', (e) => { 
                drawing = true; 
                startX = e.offsetX;
                startY = e.offsetY;
                if(currentTool === 'pencil') {
                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                }
            });
            canvas.addEventListener('mouseup', (e) => { 
                drawing = false; 
                if(currentTool !== 'pencil') {
                    drawShape(e.offsetX, e.offsetY);
                }
                ctx.beginPath();
            });
            canvas.addEventListener('mousemove', (e) => {
                if(drawing && currentTool === 'pencil') {
                    ctx.lineTo(e.offsetX, e.offsetY);
                    ctx.stroke();
                }
            });
        }
        function drawShape(endX, endY) {
            ctx.fillStyle = currentColor;
            ctx.strokeStyle = currentColor;
            const isFilled = document.getElementById('fill-shape-check').checked;
            const width = endX - startX;
            const height = endY - startY;
            
            if (currentTool === 'rectangle') {
                isFilled ? ctx.fillRect(startX, startY, width, height) : ctx.strokeRect(startX, startY, width, height);
            } else if (currentTool === 'circle') {
                const radius = Math.sqrt(width*width + height*height) / 2;
                ctx.beginPath();
                ctx.arc(startX + width/2, startY + height/2, radius, 0, 2 * Math.PI);
                isFilled ? ctx.fill() : ctx.stroke();
            }
        }
        function setTool(el) {
            currentTool = el.dataset.tool;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }
        function changeColor(el) {
            currentColor = el.dataset.color;
            ctx.strokeStyle = currentColor;
            ctx.fillStyle = currentColor;
            document.querySelectorAll('.color-swatch').forEach(sw => sw.classList.remove('active'));
            el.classList.add('active');
        }
        function changeBrushSize(el) {
            ctx.lineWidth = el.dataset.size;
            document.querySelectorAll('.brush-size').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // Mental Math
        function renderMentalMathProblem() {
            const problemEl = document.getElementById('mental-math-problem');
            if(!problemEl) return;
            const answerEl = document.getElementById('mental-math-answer');
            const feedbackEl = document.getElementById('mental-math-feedback');
            const counterEl = document.getElementById('mental-math-question-counter');
            
            const problem = mentalMathProblems[currentMentalMathProblemIndex];
            
            switch(problem.type) {
                case 'add1':
                    problemEl.textContent = `${problem.n1} + ${problem.n2} = ?`;
                    break;
                case 'sub1':
                    problemEl.textContent = `${problem.n1} - ${problem.n2} = ?`;
                    break;
                case 'add2_no_carry':
                case 'add2_carry':
                    problemEl.textContent = `${problem.n1} + ${problem.n2} = ?`;
                    break;
            }

            answerEl.value = '';
            feedbackEl.innerHTML = '';
            answerEl.focus();
            counterEl.textContent = `роХрпЗро│рпНро╡ро┐ ${currentMentalMathProblemIndex + 1} / ${mentalMathProblems.length}`;
            
            document.getElementById('mental-math-prev').disabled = currentMentalMathProblemIndex === 0;
            document.getElementById('mental-math-next').disabled = currentMentalMathProblemIndex === mentalMathProblems.length - 1;
        }

        function checkMentalMathAnswer() {
            const answerEl = document.getElementById('mental-math-answer');
            const feedbackEl = document.getElementById('mental-math-feedback');
            const problem = mentalMathProblems[currentMentalMathProblemIndex];
            
            if (answerEl.value === '') {
                feedbackEl.innerHTML = `<div class="feedback warning">родропро╡рпБроЪрпЖропрпНродрпБ роТро░рпБ ро╡ро┐роЯрпИропрпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН.</div>`;
                return;
            }
            if (parseInt(answerEl.value) === problem.answer) {
                feedbackEl.innerHTML = `<div class="feedback correct">роЪро░ро┐ропро╛рой рокродро┐ро▓рпН!</div>`;
            } else {
                feedbackEl.innerHTML = `<div class="feedback incorrect">родро╡ро▒рпБ! роЪро░ро┐ропро╛рой рокродро┐ро▓рпН ${problem.answer}.</div>`;
            }
        }

        function loadNextMentalProblem() {
            if (currentMentalMathProblemIndex < mentalMathProblems.length - 1) {
                currentMentalMathProblemIndex++;
                renderMentalMathProblem();
            }
        }

        function loadPreviousMentalProblem() {
            if (currentMentalMathProblemIndex > 0) {
                currentMentalMathProblemIndex--;
                renderMentalMathProblem();
            }
        }


        // --- Initial Load ---
        window.onload = () => {
            setupInteractiveGrid();
            setupNumberNameMatching();
            setupShapeIdentifier();
            updateBarGraph();
            setupDrawingPad();
            renderMentalMathProblem();
            document.querySelector('.tab-btn').classList.add('active');
            document.querySelector('.tab-pane').classList.add('active');
        };
    </script>
</body>

</html>
